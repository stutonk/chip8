#include <stdio.h>
#include "chip8.h"
#include "util.h"

static const uint8_t no_prog[] = {
    0x10, 0x2b, 0x90, 0xd0, 0xb0, 0x90, 0x90, 0xe0, 0x90, 0xe0, 0x80, 0x80,
    0xe0, 0x90, 0xe0, 0xa0, 0x90, 0x60, 0x90, 0x80, 0xb0, 0x60, 0xb0, 0xf0,
    0xd0, 0x90, 0x90, 0xd0, 0x15, 0x70, 0x05, 0x00, 0xee, 0x71, 0x07, 0x60,
    0x00, 0x00, 0xee, 0x70, 0x05, 0x00, 0xee, 0x61, 0x09, 0x60, 0x08, 0x64,
    0x0a, 0x65, 0x0e, 0x66, 0x05, 0x67, 0x0c, 0xa0, 0x02, 0x20, 0x1b, 0xf3,
    0x29, 0x20, 0x1b, 0x20, 0x27, 0xa0, 0x07, 0x20, 0x1b, 0xa0, 0x0c, 0x20,
    0x1b, 0xf3, 0x29, 0x20, 0x1b, 0xa0, 0x11, 0x20, 0x1b, 0xa0, 0x0c, 0x20,
    0x1b, 0xf4, 0x29, 0x20, 0x1b, 0xa0, 0x16, 0x20, 0x1b, 0x20, 0x21, 0x60,
    0x0a, 0xa0, 0x07, 0x20, 0x1b, 0xa0, 0x0c, 0x20, 0x1b, 0xf5, 0x29, 0x20,
    0x1b, 0xf6, 0x29, 0x20, 0x1b, 0x29, 0x1b, 0x20, 0x27, 0xf5, 0x29, 0x20,
    0x1b, 0xf6, 0x29, 0x20, 0x1b, 0xf7, 0x29, 0x20, 0x1b, 0x10, 0x81
};

int main(int argc, char *argv[argc+1])
{
    if (SDL_Init(0) != 0) {
        FAIL(SDL_GetError());
    }
    atexit(SDL_Quit);
    /* getopt for scale, entry point */
    chip8_init(0);
    if (argc > 1) {
        uint8_t buf[CHIP8_MEM_SZ] = {0};
        FILE *in = fopen(argv[1], "rb");
        size_t bytes_in = fread(buf, sizeof(uint8_t), CHIP8_MEM_SZ, in);
        if (!feof(in)) {
            FAIL("input file overflows available program memory");
        }
        chip8_load(0, buf, bytes_in);
    } else {
        chip8_load(0, no_prog, sizeof(no_prog));
    }
    chip8_execute(0);
    chip8_destroy();
}